<!doctype html>
<html>
<head>
  <!----- Map ----->
	<script src='https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css' rel='stylesheet' />
  
  <!-- Direction -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.css" type="text/css" />

  <!-- Distance -->
  <script src="https://npmcdn.com/@turf/turf@5.1.6/turf.min.js"></script>

  <!-- LeafLet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

</head>

<!-- <body onload="getLocation()"> -->
  <body onload="getLocation()">
	<style>
.marker {
display: block;
border: none;
border-radius: 50%;
cursor: pointer;
padding: 0;
}

.mapboxgl-popup {
max-width: 400px;
font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
}
</style>

<p id="demo"></p>

<div id='map' style='height: 500px;'></div>
<script>

mapboxgl.accessToken = 'pk.eyJ1IjoiYW5rb2FuanUiLCJhIjoiY2s5NmQwYXczMHVkdDNob201MmljZnk3OSJ9.X6W7DiJbZEsLh8RRO10T4w';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v9',
    center: [-71.12213,42.40411], // starting position 
	  zoom: 15,// starting zoom
    bearing:80 // pitch in degrees
});


//------------------- Start at a given station -----------------------//
// Add the stops
var CC_P_Row = new mapboxgl.Marker()
  .setLngLat([-71.119542, 42.405841]) 
  .addTo(map);

var Davis = new mapboxgl.Marker()
  .setLngLat([-71.122239, 42.394956]) 
  .addTo(map);

var TAB = new mapboxgl.Marker()
  .setLngLat([-71.125690, 42.401228]) 
  .addTo(map);


var CC_Talbot = new mapboxgl.Marker()
  .setLngLat([-71.120368, 42.405237]) 
  .addTo(map); 


var Carm = new mapboxgl.Marker()
  .setLngLat([-71.122610, 42.409474]) 
  .addTo(map); 

var Olin = new mapboxgl.Marker()
  .setLngLat([-71.121199, 42.408445]) 
  .addTo(map); 


//Add stop names as mouse hover pop ups

  map.on('load', function() {
  map.addSource('places', {
  'type': 'geojson',
  'data': {
  'type': 'FeatureCollection',
  'features': [
  {
  'type': 'Feature',
    'properties': {
    'description':                       
      '<strong>Mayer Campus Center P-Row</strong>',
    'icon': 'theatre'
    },
    'geometry': {
    'type': 'Point',
    'coordinates': [-71.119542, 42.405841] //CC_P_Row
    }
  },

  {
    'type': 'Feature',
    'properties': {
    'description':                        
      '<strong>Davis Square</strong>',
    'icon': 'theatre'
    },
      'geometry': {
      'type': 'Point',
      'coordinates': [-71.122239, 42.394956] // Davis Square
      }
  },

  {
    'type': 'Feature',
    'properties': {
    'description':                       
      '<strong>Tufts Administration Building</strong>',
    'icon': 'theatre'
    },
      'geometry': {
      'type': 'Point',
      'coordinates': [-71.125690, 42.401228] // TAB
      }
  },

  {
      'type': 'Feature',
      'properties': {
      'description':                        
        '<strong>Mayer Campus Ctr - Talbot</strong>',
      'icon': 'theatre'
    },
        'geometry': {
        'type': 'Point',
        'coordinates': [-71.120368, 42.405237] // CC_Talbot = new mapboxgl.Marker()
      }
    },

  {
      'type': 'Feature',
      'properties': {
      'description':                        
        '<strong>Carmichael Hall</strong>',
      'icon': 'theatre'
    },
      'geometry': {
      'type': 'Point',
      'coordinates': [-71.122610, 42.409474] // Carmichael Hall
      }
    },

    {
      'type': 'Feature',
      'properties': {
      'description':                       
        '<strong>Olin Center</strong>',
      'icon': 'theatre'
    },
      'geometry': {
      'type': 'Point',
      'coordinates': [-71.121199, 42.408445] // Olin Center
      }
    }
  ]
  }
  });

  // Add a layer showing the places.
  map.addLayer({
  'id': 'places',
  'type': 'symbol',
  'source': 'places',
  'layout': {
  'icon-image': '{icon}-15',
  'icon-allow-overlap': true
  }
  });
  
  // Create a popup, but don't add it to the map yet.
  var popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
  });
  
  map.on('mouseenter', 'places', function(e) {
  // Change the cursor style as a UI indicator.
  map.getCanvas().style.cursor = 'pointer';
  
  var coordinates = e.features[0].geometry.coordinates.slice();
  var description = e.features[0].properties.description;
  
  // Ensure that if the map is zoomed out such that multiple
  // copies of the feature are visible, the popup appears
  // over the copy being pointed to.
  while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
  coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
  }
  
  // Populate the popup and set its coordinates
  // based on the feature found.
  popup
      .setLngLat(coordinates)
      .setHTML(description)
      .addTo(map);
  });
  
  map.on('mouseleave', 'places', function() {
      map.getCanvas().style.cursor = '';
      popup.remove();
      });
  });

//------------------------- Start at my location -----------------------//
// Choose starting place and destination

// Click the button on map and display user's location
map.addControl(
    new mapboxgl.GeolocateControl({
      positionOptions: {
      enableHighAccuracy: true
    },
      trackUserLocation: true
    })
)


//------------------------- Start at any places -----------------------//
map.addControl(
    new MapboxDirections({
    accessToken: mapboxgl.accessToken
    }),
    'top-left'
);



// function getRoute() {
// 	var req = new XMLHttpRequest();


// 	// Set URL for the AJAX request to be the JSON file
// 	req.open("GET", "https://api.mapbox.com/directions/v5/mapbox/walking/"+myLat+","+myLong+";-84.512023,39.102779?steps=true&geometries=geojson&access_token=" + mapboxgl.accessToken, true);

// 	// make an XHR request https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest
//   // var req = new XMLHttpRequest();
//   req.onload = function() {
//     var json = JSON.parse(req.response);
//     var data = json.routes[0];
//     var route = data.geometry.coordinates;
//     var geojson = {
//       type: 'Feature',
//       properties: {},
//       geometry: {
//         type: 'LineString',
//         coordinates: route
//       }
//     };
//     // if the route already exists on the map, reset it using setData
//     if (map.getSource('route')) {
//       map.getSource('route').setData(geojson);
//     } else { // otherwise, make a new request
//       map.addLayer({
//         id: 'route',
//         type: 'line',
//         source: {
//           type: 'geojson',
//           data: {
//             type: 'Feature',
//             properties: {},
//             geometry: {
//               type: 'LineString',
//               coordinates: geojson
//             }
//           }
//         },
//         layout: {
//           'line-join': 'round',
//           'line-cap': 'round'
//         },
//         paint: {
//           'line-color': '#3887be',
//           'line-width': 5,
//           'line-opacity': 0.75
//         }
//       });
//     }
//     // add turn instructions here at the end
//   };
//   req.send();
// }

// map.on('load', function() {
//   // make an initial directions request that
//   // // starts and ends at the same location
//   // getRoute();

//   // Add starting point to the map
//   map.addLayer({
//     id: 'point',
//     type: 'circle',
//     source: {
//       type: 'geojson',
//       data: {
//         type: 'FeatureCollection',
//         features: [{
//           type: 'Feature',
//           properties: {},
//           geometry: {
//             type: 'Point',
//             coordinates: myLat, myLong
//           }
//         }
//         ]
//       }
//     },
//     paint: {
//       'circle-radius': 10,
//       'circle-color': '#3887be'
//     }
//   });


// });



// var geojson = {
// 	'type': 'FeatureCollection',
// 	'features': [
// 		{
// 			'type': 'Feature',
// 			'properties': {
// 			'message': 'Foo',
// 			'iconSize': [20, 20]
// 			},
// 		'geometry': {
// 			'type': 'Point',
// 			'coordinates': [-71.119622, 42.405881]
// 			}
// 		},
// 		// {
// 		// 	'type': 'Feature',
// 		// 	'properties': {
// 		// 	'message': 'Foo',
// 		// 	'iconSize': [60, 60]
// 		// 	},
// 		// 'geometry': {
// 		// 	'type': 'Point',
// 		// 	'coordinates': [myLat, myLong]
// 		// 	}
// 		// },
// 	]
// };


// // add markers to map
// geojson.features.forEach(function(marker) {
// 	// create a DOM element for the marker
// 	var el = document.createElement('div');
// 	el.className = 'marker';
// 	el.style.backgroundImage =
// 	'url(https://placekitten.com/g/' +
// 	marker.properties.iconSize.join('/') +
// 	'/)';
// 	el.style.width = marker.properties.iconSize[0] + 'px';
// 	el.style.height = marker.properties.iconSize[1] + 'px';
	 
// 	el.addEventListener('click', function() {
// 	window.alert(marker.properties.message);
// });
 
// // add marker to map
// new mapboxgl.Marker(el)
// 	.setLngLat(marker.geometry.coordinates)
// 	.addTo(map);
// });

// 

//------------------------- Get User Location ----------------------//
var x = document.getElementById("demo");
var validPos = false;

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(storeLocation);
        validPos = true;
    } else { 
        x.innerHTML = "Geolocation is not supported by this browser.";
    }

    // if (validPos)
    //   findshortest()
}

var myLat = 0.0;
var myLong = 0.0;
// display the data 
function storeLocation(position) {
  //   x.innerHTML = "Latitude: " + position.coords.latitude + 
  // "<br>Longitude: " + position.coords.longitude;

    myLat = position.coords.latitude;
    myLong = position.coords.longitude;
    findshortest(myLong, myLat);
    // document.getElementById("hihi").innerHTML = "this is lat" + myLat + "this is long" + myLong;
}

//------------------------- Find closest station ----------------------//
var stations = [
  {
    "stname" : "CC_P_Row",
    "coords" : [-71.119542, 42.405841]
  },
  {
    "stname" : "Davis",
    "coords" : [-71.122239, 42.394956]
  },
  {
    "stname" : "TAB",
    "coords" : [-71.125690, 42.401228]
  },
   {
    "stname" : "CC_Talbot",
    "coords" : [-71.120368, 42.405237]
  },
   {
    "stname" : "Carm",
    "coords" : [-71.122610, 42.409474]
  },
   {
    "stname" : "Olin",
    "coords" : [-71.121199, 42.408445]
  }
];

var indexShortest = 0;
// store an json object with coords and stnames, temporary for now
// retrive from database later
function findshortest(longval, latval) 
{
  // change after getting database 
  

// var myLocation = {"coords": [longval, latval] };
var from = turf.point([longval, latval]);

var options = {units: 'kilometers'};

// example locations: 
// var from1 = turf.point([-71.123176, 42.409626]);

var shortestname = "";
var distance = 0;
var comparedist = 0;
// var indexShortest = 0;

for (i = 0; i < stations.length; i++) {
    var to = turf.point(stations[i].coords);
    distance = turf.distance(from, to, options);
      // console.log(distance);
    if ( comparedist == 0 ){
      comparedist = distance;
    } else if ( distance < comparedist ) {
      comparedist = distance;
      shortestname = stations[i].stname;
      indexShortest = i;
      console.log("shortest to from is" + shortestname + "\n");
    }
}

  // document.getElementById("trial").innerHTML = "shortest to from1 is" + shortestname + "\n";

  // setDirection(stations);

}


//-------------- Autofill directions according to location -------------//

map.on('load', function () {
  var directions = new MapboxDirections({
    accessToken: mapboxgl.accessToken
  });
  map.addControl(directions, 'top-left');

    // create L.latLng objectsobject ->leafletjs
    // var l = L.latLng(myLat, myLong);
    console.log(myLat + " aaa " + myLong);

    directions.setOrigin(myLat + "," + myLong);

  // directions.setOrigin('Brockton Avenue, Toronto');
  console.log("index is " + indexShortest);
  console.log("this is lat" + stations[indexShortest].coords[1]);
    console.log("this is long" + stations[indexShortest].coords[0]);
  // directions.setDestination(L.latLng(stations[indexShortest].coords[1], stations[indexShortest].coords[0]));

  directions.setDestination(stations[indexShortest].coords[0] + "," + stations[indexShortest].coords[1]);
});




</script>
<p id="hihi"></p>
<p id="trial"></p>

</body>

</html>